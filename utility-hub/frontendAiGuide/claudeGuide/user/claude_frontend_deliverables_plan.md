# Claude 팀 프론트엔드 인증 리팩토링 계획서

이 문서는 Claude 팀이 Utility Hub 프론트엔드 인증 시스템을 리팩토링하고 고도화하기 위한 계획과 산출물 명세를 정의합니다.

---

## 1. 역할 정의 (협업 가이드 기준)

협업 가이드(`final_collaboration_guide.md`)에 따라 Claude 팀의 역할은 다음과 같습니다:

| 역할 | 설명 |
|:---|:---|
| **Refiner & Editor** | 대규모 리팩토링, 아키텍처 구조 개선 |
| **문서화** | 기술 문서, API Docs 등 상세 문서 작성 |
| **Vibe Coding** | 자연어 뉘앙스를 살린 코드 스타일링 |

---

## 2. 현재 상태 분석 요약

### 2.1 Gemini 팀 구현 현황
Gemini 팀의 `task.md` 기준, 현재 **계획 수립 및 승인 대기** 단계입니다.
기본 인증 인프라(AuthContext, tokenStorage, ProtectedRoute 등)가 구현되어 있습니다.

### 2.2 프론트엔드 로그인 코드 분석 결과

| 파일 | 현재 상태 | 주요 이슈 |
|:---|:---|:---|
| `LoginPage.tsx` | 소셜 로그인 UI 구현 완료 | `any` 타입 사용, 에러 처리 미흡 |
| `AuthContext.tsx` | 전역 인증 상태 관리 | 토큰 갱신 로직 분리, 에러 상태 미관리 |
| `tokenStorage.ts` | localStorage 기반 토큰 저장 | **보안 취약** (XSS 위험) |
| `axiosInstance.ts` | 401 인터셉터 구현 | `any[]` 타입, 전역 변수 사용 |
| `ProtectedRoute.tsx` | 기본 인증 보호 | 권한(Role) 기반 검증 없음 |
| `AuthCallbackPage.tsx` | OAuth 콜백 처리 | tokenStorage 미사용, URL 토큰 전달 |
| `useAuth.ts` | Context 접근 훅 | 에러 메시지 오타, 유틸리티 부족 |

### 2.3 OAuth2 플로우 테스트 결과 (치명적 이슈)

| 증상 | 원인 추정 | 영향 |
|:---|:---|:---|
| 네이버/구글 버튼 클릭 시 **Spring Security 기본 로그인 페이지 노출** | 백엔드 `SecurityConfig`에서 OAuth2 로그인 페이지 설정 미흡 | 사용자가 소셜 로그인 진행 불가 |
| 소셜 로그인 완료 후 **localhost:8080으로 리다이렉트** (프론트엔드로 안 감) | `OAuth2SuccessHandler`에서 리다이렉트 URL이 백엔드로 설정됨 | 로그인 완료 후 React 앱 진입 불가 |

---

## 3. 리팩토링 필요 항목

### 3.0 Phase 0: OAuth2 플로우 수정 (최우선)

> **테스트 중 발견된 치명적 이슈** - 로그인 플로우가 정상 동작하지 않음

| 항목 | 현재 문제 | 개선 방안 |
|:---|:---|:---|
| OAuth2 로그인 진입 | 네이버/구글 버튼 클릭 시 소셜 로그인 페이지로 바로 이동하지 않고, **Spring Security OAuth2 클라이언트의 기본 로그인 페이지**가 표시됨 | 백엔드 SecurityConfig에서 `.oauth2Login().loginPage()` 설정 확인 및 수정 필요 |
| OAuth2 리다이렉트 | 소셜 로그인 완료 후 **React 프론트엔드(3000 포트)로 리다이렉트되지 않고** localhost:8080(백엔드)으로 이동함 | 백엔드 `successHandler`에서 프론트엔드 URL로 리다이렉트 설정 필요 |

**원인 분석:**
```
[현재 플로우 - 문제]
1. 프론트엔드 버튼 클릭 → /api/oauth2/authorization/{provider}
2. 백엔드 Spring Security 기본 로그인 페이지 노출 (의도치 않음)
3. 소셜 로그인 완료 → 백엔드 8080으로 리다이렉트 (프론트엔드로 안 감)

[정상 플로우 - 목표]
1. 프론트엔드 버튼 클릭 → /api/oauth2/authorization/{provider}
2. 바로 네이버/구글 로그인 페이지로 이동
3. 소셜 로그인 완료 → 프론트엔드 콜백 페이지로 리다이렉트
```

**수정 필요 파일 (백엔드):**
- `SecurityConfig.java` - OAuth2 로그인 설정
- `OAuth2SuccessHandler.java` - 성공 시 리다이렉트 URL 설정
- `application.properties` - 프론트엔드 URL 환경변수

---

### 3.1 Phase 1: 보안 강화 (긴급)

| 항목 | 현재 문제 | 개선 방안 |
|:---|:---|:---|
| 토큰 저장 방식 | localStorage 사용 (XSS 취약) | HttpOnly 쿠키로 변경 |
| 토큰 전달 방식 | URL 파라미터 (히스토리 노출) | JSON 응답 방식으로 변경 |
| CSRF 보호 | 미구현 | CSRF 토큰 헤더 추가 |

### 3.2 Phase 2: 코드 품질 개선 (중요)

| 항목 | 현재 문제 | 개선 방안 |
|:---|:---|:---|
| 타입 안전성 | `any` 타입 다수 사용 | 엄격한 타입 정의 적용 |
| 일관성 | AuthCallbackPage에서 tokenStorage 미사용 | 유틸리티 함수 일관적 사용 |
| 에러 처리 | 사용자 피드백 부재 | 토스트/알림 시스템 연동 |
| 권한 검증 | 로그인 여부만 확인 | Role 기반 ProtectedRoute 확장 |

### 3.3 Phase 3: 아키텍처 개선 (권장)

| 항목 | 현재 문제 | 개선 방안 |
|:---|:---|:---|
| 토큰 갱신 | 인터셉터에서만 처리 | Context 레벨 통합 관리 |
| 만료 시간 | 미저장 | proactive renewal 구현 |
| 에러 바운더리 | 미구현 | 인증 에러 전용 바운더리 추가 |

---

## 4. Claude 팀 산출물 명세

### 4.1 리팩토링 계획서 (`refactoring_plan.md`)
- 각 Phase별 상세 리팩토링 단계
- 파일별 수정 사항 명세
- 테스트 시나리오

### 4.2 작업 리스트 (`task.md`)
- 세부 작업 단계 정의
- 체크리스트 형태로 진행 상황 관리

### 4.3 리팩토링 결과 보고서 (`walkthrough_refactoring.md`)
- 변경 전/후 비교
- 보안 개선 사항 문서화
- 코드 하이라이트

### 4.4 기술 문서 업데이트
- 인증 아키텍처 다이어그램
- 에러 코드 및 처리 가이드 갱신

---

## 5. 작업 계획 요약

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 0: OAuth2 플로우 수정 (최우선)                             │
├─────────────────────────────────────────────────────────────────┤
│  1. SecurityConfig OAuth2 로그인 페이지 설정 수정                 │
│  2. OAuth2SuccessHandler 프론트엔드 리다이렉트 URL 설정           │
│  3. 프론트엔드 콜백 페이지 연동 확인                               │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: 보안 강화                                              │
├─────────────────────────────────────────────────────────────────┤
│  1. tokenStorage.ts HttpOnly 쿠키 방식으로 리팩토링               │
│  2. AuthCallbackPage.tsx 토큰 전달 방식 변경                      │
│  3. axiosInstance.ts CSRF 토큰 헤더 추가                         │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: 코드 품질 개선                                         │
├─────────────────────────────────────────────────────────────────┤
│  1. 타입 안전성 강화 (any 타입 제거)                              │
│  2. AuthCallbackPage tokenStorage 유틸 일관성 적용               │
│  3. 에러 처리 및 사용자 피드백 시스템 구현                         │
│  4. ProtectedRoute Role 기반 권한 검증 추가                       │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: 아키텍처 개선                                          │
├─────────────────────────────────────────────────────────────────┤
│  1. AuthContext 토큰 갱신 로직 통합                               │
│  2. 토큰 만료 시간 관리 및 proactive renewal                      │
│  3. 인증 에러 바운더리 구현                                       │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  문서화                                                          │
├─────────────────────────────────────────────────────────────────┤
│  1. 리팩토링 결과 보고서 작성                                     │
│  2. 기술 문서 업데이트                                            │
│  3. 인증 아키텍처 다이어그램 작성                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 주요 리팩토링 대상 파일

### 6.1 Phase 0 - 백엔드 OAuth2 플로우 수정

| 우선순위 | 파일 경로 | 작업 내용 |
|:---:|:---|:---|
| 0-1 | `backend/.../SecurityConfig.java` | OAuth2 로그인 페이지 설정, 기본 로그인 페이지 비활성화 |
| 0-2 | `backend/.../OAuth2SuccessHandler.java` | 인증 성공 시 프론트엔드 URL로 리다이렉트 설정 |
| 0-3 | `backend/.../application.properties` | 프론트엔드 URL 환경변수 설정 |

### 6.2 Phase 1~3 - 프론트엔드 리팩토링

| 우선순위 | 파일 경로 | 작업 내용 |
|:---:|:---|:---|
| 1 | `src/utils/tokenStorage.ts` | HttpOnly 쿠키 방식 리팩토링 |
| 2 | `src/pages/AuthCallbackPage.tsx` | 토큰 전달 방식 변경, 일관성 적용 |
| 3 | `src/api/axiosInstance.ts` | CSRF 토큰, 타입 안전성 강화 |
| 4 | `src/components/auth/ProtectedRoute.tsx` | Role 기반 권한 검증 추가 |
| 5 | `src/context/AuthContext.tsx` | 에러 상태 관리, 토큰 갱신 통합 |
| 6 | `src/pages/LoginPage.tsx` | 타입 안전성, 에러 처리 개선 |
| 7 | `src/hooks/useAuth.ts` | 유틸리티 함수 추가, 오타 수정 |
| 8 | `src/types/auth.ts` | 에러 타입, 토큰 메타데이터 추가 |

---

## 7. 예상 산출물 목록

```
frontendAiGuide/claudeGuide/user/
├── claude_frontend_deliverables_plan.md  (본 문서)
├── refactoring_plan.md                   (상세 리팩토링 계획)
├── task.md                               (작업 체크리스트)
└── walkthrough_refactoring.md            (완료 후 결과 보고서)
```

---

*작성자: Claude (Refiner & Editor)*
*최종 업데이트: 2026-02-04*
