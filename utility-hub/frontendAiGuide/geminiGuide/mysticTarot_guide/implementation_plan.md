# 미스틱 타로 공유, 저장, 기록 및 게스트 연동 구현 계획 (최종)

이 계획은 미스틱 타로의 **저장, 공유, 기록 관리** 기능과 더불어 **게스트 데이터 연동**을 통해 사용자 경험을 극대화하는 것을 목표로 합니다.

## 분석 결과 (Analysis)

### 1. 인증 및 저장 (Auth & Persistence)
- **현황**: 타로 결과는 `TarotReadingSession`에 저장되지만, 회원(`Member`)과 연동되지 않아 '나의 기록'으로 관리되지 않습니다.
- **개선**: 로그인 시 `Session`에 `memberId`를 매핑하여 영구 보관합니다.

### 2. 게스트 경험 (Guest Experience)
- **현황**: 비로그인 상태의 결과는 일회성으로 휘발됩니다.
- **개선**: 게스트 상태의 리딩 결과를 `localStorage`에 임시 저장하고, 로그인 직후 계정으로 이관(Migration)합니다.

### 3. 공유 (Sharing)
- **현황**: 공유 불가.
- **개선**: UUID 기반의 공개 링크를 생성하여 결과를 공유할 수 있게 합니다.

## 변경 제안 (Proposed Changes)

### 백엔드 (Backend)

#### [수정] 도메인 모델 (`TarotReadingSession`)
- `memberId` 필드 추가 (Nullable).
- `shareUuid` 필드 추가 (공유 전용 식별자, 난수화).

#### [수정] 컨트롤러 & 서비스
- **저장**: 로그인 사용자라면 `memberId` 저장.
- **공유**: `GET /api/tarot/share/{shareUuid}` (보안을 위해 PK 대신 UUID 사용 권장).
- **기록**: `GET /api/tarot/history` (Pageable).
- **삭제**: `DELETE /api/tarot/history/{sessionId}`.
- **[NEW] 연동**: `POST /api/tarot/migrate` (게스트 세션 ID 목록을 받아 내 계정으로 업데이트).

### 프론트엔드 (Frontend)

#### [신규] 로직 및 페이지
- **게스트 연동 로직**:
    - 리딩 완료 시 `localStorage`에 `guestSessionIds` 저장.
    - 로그인 성공(`AuthCallbackPage`) 시 백엔드로 이관 요청 후 스토리지 비움.
- **기록 페이지**: `/tarot/history` (리스트 및 삭제).
- **공유 페이지**: `/tarot/share/:shareUuid` (읽기 전용).

#### [수정] 기존 UI
- **결과 화면**: '공유하기(링크복사)', '기록보기' 버튼 추가.
- **헤더**: 로그인 시 '타로 기록' 메뉴 추가.

## 작업 규모 추정 (Work Estimate)

### 백엔드 (Backend)
- **난이도**: 하 (Low) -> **중 (Medium)** (게스트 연동 로직 추가됨)
- **작업**: DB 마이그레이션(컬럼 추가), API 3~4개 구현.

### 프론트엔드 (Frontend)
- **난이도**: 중 (Medium)
- **작업**:
    - `useGuestTarot` 훅 (로컬 스토리지 관리).
    - 로그인 콜백 페이지 수정 (데이터 이관 트리거).
    - 신규 페이지 2개 (`History`, `Share`).

### 총평
- **예상 소요 시간**: 약 3~4 task blocks.
- **리스크**: 게스트 데이터 이관 시 소유권 검증 (세션 ID만 알면 훔쳐갈 수 있는 리스크가 있으나, MVP 단계에선 로컬 스토리지 기반으로 신뢰).

## 검증 계획

### 자동화 테스트
- **통합 테스트**: 게스트 세션을 내 계정으로 가져오는 API 테스트.

### 수동 검증
1. **게스트 시나리오**:
    - 로그아웃 상태에서 점을 본다 -> 결과 확인.
    - 로그인 한다 -> '기록 페이지'에 방금 본 점이 있는지 확인.
2. **공유 시나리오**:
    - 공유 링크 생성 -> 시크릿 탭에서 접속 확인.
